import asyncio
from aiogram import Bot, Dispatcher,F,types
from aiogram.types import Message
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart,Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.client.bot import DefaultBotProperties
from aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup,CallbackQuery
from game_keyboard import lobby_keyboards,pole_keyboards,keyboards_buttons
import lobby as lb
from lobby import find_lobby
from GameSession import game
import os
from data_players import join_json,win_json,losses_json,parsing_json
from dotenv import load_dotenv,find_dotenv
load_dotenv(find_dotenv())

bot = Bot(os.getenv("TOKEN"), default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

@dp.message(CommandStart())
async def start_handler(message: Message):
    user_id = message.from_user.id
    join_json(user_id)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º: ", reply_markup=keyboards_buttons)
    await message.answer("–°–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /stats")

@dp.message(Command("stats"))
async def clear_field(message: Message):
    first_name = message.from_user.first_name
    user_id = message.from_user.id 
    wins,losses = parsing_json(user_id)
    await message.answer(f"–ò–≥—Ä–æ–∫: {first_name} \n–ü–æ–±–µ–¥: {wins} \n–ü—Ä–æ–∏–≥—Ä—ã—à–µ–π: {losses}")   

@dp.message(F.text == "üïπ –ò–≥—Ä–∞—Ç—å")
async def play(message: Message):
    await message.answer("–ò–≥—Ä–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π:", reply_markup=await pole_keyboards())
    

@dp.message(F.text == "ü§º‚Äç‚ôÇ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏")
async def join_lobby(message: Message):
    global message_x,message_y
    user_id = message.from_user.id
    lb.handle_join(user_id)
    if lb.waiting_lobby is not None:
        await bot.send_message(user_id, text="–í—ã –∑–∞—à–ª–∏ –≤ –ª–æ–±–±–∏, –æ–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞")
        join_json(user_id)
    else:
        lobby = find_lobby(user_id)
        join_json(user_id)
        message_x = await bot.send_message(lobby.player_x,text="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å",reply_markup=await lobby_keyboards(user_id))
        message_y = await bot.send_message(lobby.player_y,text="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å",reply_markup=await lobby_keyboards(user_id))
        lobby.player_x_message = message_x.message_id
        lobby.player_y_message = message_y.message_id
        print(message_x.message_id,message_y.message_id)
    

@dp.callback_query(F.data.startswith('game_'))
async def handle_callback(callback: CallbackQuery):
    user_id = callback.from_user.id
    lobby = find_lobby(user_id)
    data = callback.data.split("_")
    row = int(data[1])
    col = int(data[2])

    if lobby.player_turn == lobby.player_x:
        turn = "‚ùå"
    else:
        turn = "‚≠ïÔ∏è"

    if lobby.player_turn != user_id:
        await callback.answer("–ù–µ –≤–∞—à —Ö–æ–¥!",show_alert=True, reply_markup=await lobby_keyboards(user_id))
        return
    
    if  lobby.game_session.field[row][col] != " ":
        await callback.answer("–ö–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞! –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥—É—é.",show_alert=True, reply_markup=await lobby_keyboards(user_id))
    
    else:
        lobby.game_session.field[row][col] = turn
        await bot.edit_message_text(chat_id = lobby.player_x,message_id = lobby.player_x_message,text=f"{turn} –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –∫–ª–µ—Ç–∫—É {row}-{col}",reply_markup=await lobby_keyboards(user_id))
        await bot.edit_message_text(chat_id = lobby.player_y,message_id = lobby.player_y_message,text=f"{turn} –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –∫–ª–µ—Ç–∫—É {row}-{col}",reply_markup=await lobby_keyboards(user_id))
        lobby.switch_player_turn()

    if lobby.game_session.check_win() is True:
        await bot.edit_message_text(chat_id = lobby.player_x,message_id = lobby.player_x_message,text=f"–ü–æ–±–µ–¥–∏–ª: {lobby.game_session.winner}")
        await bot.edit_message_text(chat_id = lobby.player_y,message_id = lobby.player_y_message,text=f"–ü–æ–±–µ–¥–∏–ª: {lobby.game_session.winner}")
        if lobby.player_turn == lobby.player_x:
            user_id = lobby.player_turn
            win_json(user_id)
            user_id2 = lobby.player_y
            losses_json(user_id2)
        
        else:
            user_id = lobby.player_y
            win_json(user_id)
            user_id2 = lobby.player_x
            losses_json(user_id2)
        lobby.game_session.clear()

    if lobby.game_session.is_draw() is True:
        await bot.edit_message_text(chat_id = lobby.player_x,message_id = lobby.player_x_message,text="–ù–∏—á—å—è")
        await bot.edit_message_text(chat_id = lobby.player_y,message_id = lobby.player_y_message,text="–ù–∏—á—å—è") 
        lobby.game_session.clear()
    



async def main():
    try:
        print("Online!")
        await dp.start_polling(bot)
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    asyncio.run(main())


